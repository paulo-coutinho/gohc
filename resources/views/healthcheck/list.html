{{define "content"}}
<div class="healthcheck-list">

	<div class="col-md-8 col-lg-8">
		<!-- DATA -->
		<div id="data">
			<div id="healthcheck-list" class="list-group"></div>
		</div>

		<div id="no-data">
			<div class="panel panel-default">
				<div class="panel-body">
					<div>No healthchecks found</div>
				</div>
			</div>
		</div>

		<div id="error-data">
			<div class="panel panel-default">
				<div class="panel-body">
					<h3>Problem while loading healthcheck list</h3>
					<p id="error-data-message"></p>
					<button type="button" class="btn btn-primary" onclick="load();">Try again</button>
				</div>
			</div>
		</div>

		<div id="loading-data">
			<div class="panel panel-default">
				<div class="panel-body">Loading...</div>
			</div>
		</div>
	</div>
	<div class="col-md-4 col-lg-4">
		<div id="graph-data">
			<div class="panel panel-default">
				<div class="panel-body">
					<h3>Healthcheck graph</h3>
					<br/>
					<canvas id="graph"></canvas>
				</div>
			</div>
		</div>

		<div id="graph-no-data">
			<div class="panel panel-default">
				<div class="panel-body">
					<div>No healthchecks for graph</div>
				</div>
			</div>
		</div>

		<div id="graph-error-data">
			<div class="panel panel-default">
				<div class="panel-body">
					<div>Problem while loading healthcheck list</div>
				</div>
			</div>
		</div>

		<div id="graph-loading-data">
			<div class="panel panel-default">
				<div class="panel-body">Loading...</div>
			</div>
		</div>
	</div>

</div>

<!-- STARTUP -->
<script>
	var lastGraphTotalSuccess = 0;
	var lastGraphTotalWarning = 0;
	var lastGraphTotalError = 0;
	var graph = null;
	var graphDataChanged = false;

	function load() {
		Healthcheck.list(function () {
			// ?
		}, function (wr) {
			var errorMessage = null;

			if (wr.success) {
				var list = wr.getDataItem("list");

				// check for invalid list
				if (Util.isNullOrUndefined(list)) {
					Util.showNoData();
					Util.showNoData('graph');
					HealthcheckList.clearHealthcheckHtmlList();
					HealthcheckList.clearList();
					autoLoad();
					return;
				}

				// update current healthcheck list - add new healthcheck to list
				if (list.length > 0) {
					for (var x = 0; x < list.length; x++) {
						var healthcheck = list[x];

						if (!HealthcheckList.hasHealthcheckById(healthcheck.token)) {
							HealthcheckList.addHealthcheck(healthcheck);
						}
					}
				}

				// update current healthcheck list - remove old healthchecks from list
				for (var x = 0; x < healthcheckList.length; x++) {
					var healthcheck = healthcheckList[x];
					var found = false;

					for (var y = 0; y < list.length; y++) {
						if (list[y].token == healthcheck.token) {
							found = true;
							break;
						}
					}

					if (!found) {
						HealthcheckList.removeHealthcheckById(healthcheck.token);
						$("#healthcheck-row-" + healthcheck.token).remove();
					}
				}

				// update current healthcheck list - remove healthchecks that not exists
				for (var x = 0; x < list.length; x++) {
					var healthcheck = list[x];
					var found = false;

					for (var y = 0; y < healthcheckList.length; y++) {
						if (healthcheckList[y].token == healthcheck.token) {
							found = true;
							break;
						}
					}

					if (!found) {
						HealthcheckList.removeHealthcheckById(healthcheck.token);
						$("#healthcheck-row-" + healthcheck.token).remove();
					}
				}

				// update current healthcheck list - only data
				for (var x = 0; x < healthcheckList.length; x++) {
					var healthcheck = healthcheckList[x];

					for (var y = 0; y < list.length; y++) {
						var currentHealthcheck = list[y];

						if (healthcheck.token == currentHealthcheck.token) {
							healthcheck.status = currentHealthcheck.status;
							healthcheck.ping = currentHealthcheck.ping;
							healthcheck.range = currentHealthcheck.range;
							healthcheck.description = currentHealthcheck.description;
							break;
						}
					}
				}

				// add html for healthcheck if not exists
				for (var x = 0; x < healthcheckList.length; x++) {
					var healthcheck = healthcheckList[x];

					if (!$("#healthcheck-row-" + healthcheck.token).length > 0) {
						Healthcheck.addHealthcheckToHTML(healthcheck);
					}

					// set healthcheck data on html
					$(".ph-healthcheck-token-" + healthcheck.token).html(healthcheck.token);
					$(".ph-healthcheck-value-ping-" + healthcheck.token).html(Util.msToHumanText(healthcheck.ping));
					$(".ph-healthcheck-value-range-" + healthcheck.token).html(healthcheck.range);
					$(".ph-healthcheck-value-status-" + healthcheck.token).html(healthcheck.status);

					var statusHTML = "";

					if (healthcheck.status == Healthcheck.STATUS_SUCCESS) {
						statusHTML += '<span class="label label-success">' + healthcheck.status + '</span>';
					} else if (healthcheck.status == Healthcheck.STATUS_WARNING) {
						statusHTML += '<span class="label label-warning">' + healthcheck.status + '</span>';
					} else if (healthcheck.status == Healthcheck.STATUS_ERROR) {
						statusHTML += '<span class="label label-danger">' + healthcheck.status + '</span>';
					} else {
						statusHTML += '<span class="label label-success">' + healthcheck.status + '</span>';
					}

					var currentHealthcheckStatus = HealthcheckList.getHealthcheckLastStatusById(healthcheck.token);

					if (currentHealthcheckStatus != healthcheck.status) {
						HealthcheckList.updateHealthcheckLastStatusById(healthcheck.token, healthcheck.status);
						$(".ph-healthcheck-status-" + healthcheck.token).html(statusHTML);
					}
				}

				if (healthcheckList.length > 0) {
					Util.showData();
				} else {
					Util.showNoData();
				}

				// create graph

				var graphTotalSuccess = 0;
				var graphTotalWarning = 0;
				var graphTotalError = 0;

				for (var x = 0; x < healthcheckList.length; x++) {
					var healthcheck = healthcheckList[x];

					if (healthcheck.status == Healthcheck.STATUS_SUCCESS) {
						graphTotalSuccess = graphTotalSuccess + 1;
					} else if (healthcheck.status == Healthcheck.STATUS_WARNING) {
						graphTotalWarning = graphTotalWarning + 1;
					} else if (healthcheck.status == Healthcheck.STATUS_ERROR) {
						graphTotalError = graphTotalError + 1;
					}
				}

				var graphTotal = graphTotalSuccess + graphTotalWarning + graphTotalError;

				if (graphTotal == 0) {
					Util.showNoData('graph');
				} else {
					if (graphTotalSuccess != lastGraphTotalSuccess) {
						lastGraphTotalSuccess = graphTotalSuccess;
						graphDataChanged = true;
					} else if (graphTotalWarning != lastGraphTotalWarning) {
						lastGraphTotalWarning = graphTotalWarning;
						graphDataChanged = true;
					} else if (graphTotalError != lastGraphTotalError) {
						lastGraphTotalError = graphTotalError;
						graphDataChanged = true;
					}

					var graphDatasets = [];
					var graphDataLabels = [];
					var graphDataColors = [];

					if (graphTotalSuccess > 0) {
						graphDatasets.push(graphTotalSuccess);
						graphDataLabels.push('Success');
						graphDataColors.push('#1bbf89');
					}

					if (graphTotalWarning > 0) {
						graphDatasets.push(graphTotalWarning);
						graphDataLabels.push('Warning');
						graphDataColors.push('#f7af3e');
					}

					if (graphTotalError > 0) {
						graphDatasets.push(graphTotalError);
						graphDataLabels.push('Error');
						graphDataColors.push('#DB524B');
					}

					var graphData = {
						animation: {
							animateScale: false,
							animateRotate: false
						},
						labels: graphDataLabels,
						datasets: [
							{
								data: graphDatasets,
								backgroundColor: graphDataColors,
								hoverBackgroundColor: graphDataColors
							}
						]
					};

					var graphContext = document.getElementById("graph");
					var graphOptions = {
						animation: false
					};

					if (Util.isNullOrUndefined(graph)) {
						graph = new Chart(graphContext, {
							type: 'doughnut',
							data: graphData,
							options: graphOptions
						});
					} else {
						if (graphDataChanged) {
							graphDataChanged = false;

							graph.data.labels = graphData.labels;
							graph.data.datasets = graphData.datasets;
							graph.data.backgroundColor = graphData.backgroundColor;
							graph.data.hoverBackgroundColor = graphData.hoverBackgroundColor;

							graph.update();
						}
					}

					Util.showData('graph');
				}
			} else {
				errorMessage = Util.getFirstErrorMessage(wr.data.errors);
			}

			if (errorMessage) {
				HealthcheckList.clearHealthcheckHtmlList();
				HealthcheckList.clearList();
				Util.showErrorData(errorMessage);
			}

			autoLoad();
		}, function () {
			Util.showErrorData("An error occurred while processing your request, try again!");
			Util.showErrorData("An error occurred while processing your request, try again!", "graph");
			HealthcheckList.clearHealthcheckHtmlList();
			HealthcheckList.clearList();
			autoLoad();
		});
	}

	function autoLoad() {
		setTimeout(function () {
			load();
		}, 1000);
	}

	function back() {
		Util.redirect("/");
	}

	$(document).ready(function () {
		load();
	});
</script>
{{end}}